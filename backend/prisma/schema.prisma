generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [citext()]
}

/**
 * =========================
 * ENUMS
 * =========================
 */

enum StatusPagamento {
  PENDENTE
  PAGO
  CANCELADO
}

enum TipoMovimento {
  ENTRADA
  SAIDA
  AJUSTE
  TRANSFERENCIA
  VENDA
}

enum TipoUsuario {
  adm
  filiado
  vendedor
}

/**
 * =========================
 * CORE DE CLIENTES & VENDAS
 * =========================
 */

model Cliente {
  id         String    @id @default(uuid())
  nome       String
  cpf        String    @unique
  nascimento DateTime?
  whatsapp   String?
  cidade     String?
  estado     String?
  endereco   String?
  criadoEm   DateTime  @default(now())
  cep        String?

  vendas Venda[]

  @@index([nome])
}

model Venda {
  id                 String          @id @default(uuid())
  data               DateTime        @default(now())
  clienteId          String
  clienteNome        String
  carrinho           Json
  subtotal           Float
  totalFinal         Float
  descontoPercentual Float?
  descontoValor      Float?
  destinoDesconto    String?
  frete              Float?
  acrescimo          Float?
  formaPagamento     String
  parcelas           Int?
  status_pagamento   StatusPagamento @default(PENDENTE)
  observacoes        String          @default("")

  cliente Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  filialId String
  filial   Filial @relation(fields: [filialId], references: [id], onDelete: Cascade)

  // vendedor como fonte de divisão por usuário
  vendedorId String?
  vendedor   Usuario? @relation(fields: [vendedorId], references: [id], onDelete: SetNull)

  // back-relation p/ movimentos de estoque gerados por esta venda
  movimentos MovimentoEstoque[] @relation("VendaMovimentos")

  @@index([filialId, data])
  @@index([vendedorId, data])
}

/**
 * =========================
 * ESTOQUE / CATEGORIAS
 * =========================
 */

model CategoriaEstoque {
  id    String @id @default(uuid())
  marca String
  tipo  String

  // unicidade por filial
  filialId String
  filial   Filial @relation("FilialCategorias", fields: [filialId], references: [id])

  // back-relation para ProdutoEstoque
  produtos ProdutoEstoque[] @relation("CategoriaProdutos")

  @@unique([marca, tipo, filialId], name: "marca_tipo_filial")
  @@index([filialId])
}

model Estoque {
  id          String  @id @default(uuid())
  nome        String
  cidade      String
  estado      String?
  observacoes String?

  // Estoque atrelado a uma filial (opcional)
  filialId String?
  filial   Filial? @relation(fields: [filialId], references: [id])

  produtos  ProdutoEstoque[]
  criado_em DateTime         @default(now())

  // Se desejar garantir unicidade de nome+cidade por filial, descomente:
  // @@unique([nome, cidade, filialId], name: "estoque_nome_cidade_filial_unico")

  @@index([filialId])
}

model ProdutoEstoque {
  id                    String   @id @default(uuid())
  codigo                String
  nome                  String
  tipo                  String
  marca                 String
  preco_compra          Float
  preco_venda_unidade   Float
  preco_venda_caixa     Float
  quantidade_em_estoque Int
  unidades_por_caixa    Int
  caixas                Int
  criado_em             DateTime @default(now())

  // Categoria
  categoriaId String
  categoria   CategoriaEstoque @relation("CategoriaProdutos", fields: [categoriaId], references: [id])

  // Multi-estoques: pertence a um estoque
  estoqueId String
  estoque   Estoque @relation(fields: [estoqueId], references: [id])

  // Compatibilidade/relatórios: filial opcional
  filialId String?
  filial   Filial? @relation(fields: [filialId], references: [id])

  movimentos            MovimentoEstoque[]
  transferenciasOrigem  TransferenciaEstoque[] @relation("ProdutoOrigem")
  transferenciasDestino TransferenciaEstoque[] @relation("ProdutoDestino")

  // Código único dentro do estoque
  @@unique([estoqueId, codigo], name: "codigo_por_estoque_unico")
  @@index([estoqueId])
  @@index([categoriaId])
  @@index([filialId])
}

/**
 * =========================
 * USUÁRIOS / EQUIPE
 * =========================
 */

model Usuario {
  id           String      @id @default(uuid())
  nome         String
  email        String?     @unique @db.Citext // opcional
  senha        String
  tipo         TipoUsuario @default(vendedor)
  cidade       String?
  cpf          String      @unique
  nascimento   DateTime?
  whatsapp     String? // opcional
  avatar       String?
  criadoEm     DateTime    @default(now())
  atualizadoEm DateTime    @updatedAt
  filialId     String?
  filial       Filial?     @relation(fields: [filialId], references: [id])

  vendas Venda[]

  @@index([filialId])
  @@index([tipo])
  @@index([nome])
}

model Membro {
  id       String  @id @default(uuid())
  nome     String
  avatar   String?
  usos     Int     @default(0)
  comissao Float   @default(0)
  salvo    Boolean @default(true)
  cargo    String?
}

/**
 * =========================
 * FILIAIS (UF/ESTADOS)
 * =========================
 */

model Filial {
  id     String  @id @default(uuid())
  nome   String
  uf     String
  slug   String  @unique
  ativa  Boolean @default(true)
  corHex String?
  icone  String?

  criadoEm DateTime @default(now())

  // back-relations
  categorias CategoriaEstoque[] @relation("FilialCategorias")
  estoque    ProdutoEstoque[] // produtos associados à filial (via ProdutoEstoque.filialId)
  vendas     Venda[]
  usuarios   Usuario[]
  movimentos MovimentoEstoque[]

  transferenciasOrigem  TransferenciaEstoque[] @relation("TransferenciasOrigem")
  transferenciasDestino TransferenciaEstoque[] @relation("TransferenciasDestino")

  // estoques físicos cadastrados (multi-estoque)
  estoques Estoque[]

  @@index([nome])
  @@index([uf])
}

/**
 * =========================================
 * MOVIMENTAÇÃO & TRANSFERÊNCIA DE ESTOQUE
 * =========================================
 */
model MovimentoEstoque {
  id         String        @id @default(uuid())
  data       DateTime      @default(now())
  tipo       TipoMovimento
  quantidade Int
  saldoApos  Int?

  produtoId String
  produto   ProdutoEstoque @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  filialId String
  filial   Filial @relation(fields: [filialId], references: [id], onDelete: Cascade)

  // vínculos opcionais para auditoria
  vendaId String?
  venda   Venda?  @relation("VendaMovimentos", fields: [vendaId], references: [id], onDelete: SetNull)

  transferenciaId String?
  transferencia   TransferenciaEstoque? @relation("TransfMovimentos", fields: [transferenciaId], references: [id], onDelete: SetNull)

  @@index([filialId, data])
  @@index([produtoId, data])
}

model TransferenciaEstoque {
  id            String   @id @default(uuid())
  data          DateTime @default(now())
  produtoNome   String
  produtoCodigo String?
  quantidade    Int
  observacao    String?

  origemFilialId String
  origemFilial   Filial @relation("TransferenciasOrigem", fields: [origemFilialId], references: [id], onDelete: Cascade)

  destinoFilialId String
  destinoFilial   Filial @relation("TransferenciasDestino", fields: [destinoFilialId], references: [id], onDelete: Cascade)

  produtoOrigemId String?
  produtoOrigem   ProdutoEstoque? @relation("ProdutoOrigem", fields: [produtoOrigemId], references: [id], onDelete: Cascade)

  produtoDestinoId String?
  produtoDestino   ProdutoEstoque? @relation("ProdutoDestino", fields: [produtoDestinoId], references: [id], onDelete: Cascade)

  // back-relation para movimentos vinculados à transferência
  movimentos MovimentoEstoque[] @relation("TransfMovimentos")

  @@index([origemFilialId, data])
  @@index([destinoFilialId, data])
}
